name: Projects dates update (cron)
on:
  schedule:
    - cron: '0 * * * *' # Každou hodinu
  workflow_dispatch:      # Pro ruční spuštění

jobs:
  sync-all:
    runs-on: ubuntu-latest
    steps:
      - name: Sync All Organization Projects
        env:
          GH_TOKEN: ${{ secrets.TEST_PROJECT_TOKEN }}
          OWNER: "jankoweb-test-org" # <--- SEM NAPIŠTE JMÉNO ORG NEBO USERA
          FIELD_CREATED: "added"   # Název vašeho sloupce v projektu
          FIELD_UPDATED: "edited"  # Název vašeho sloupce v projektu
        run: |
          echo "Hledám všechny projekty pro $OWNER..."

          # Detect owner type (org or user)
          if gh api "orgs/$OWNER" >/dev/null 2>&1; then
            OWNER_TYPE=org
          else
            OWNER_TYPE=user
          fi
          echo "Owner type: $OWNER_TYPE"

          if [ "$OWNER_TYPE" = "org" ] && ! gh api "orgs/$OWNER" >/dev/null 2>&1; then
            echo "Token nemá přístup k organizaci '$OWNER'."
            echo "Pro org projekty je potřeba minimálně scope: read:org"
            exit 1
          fi

          fetch_project_numbers() {
            local cursor=""
            local has_next="true"
            local end_cursor=""
            local response=""
            local numbers=""
            local result=""

            while [ "$has_next" = "true" ]; do
              if [ "$OWNER_TYPE" = "org" ]; then
                if [ -z "$cursor" ]; then
                  response=$(gh api graphql -f query='query($owner: String!) { organization(login: $owner) { projectsV2(first: 100) { nodes { number } pageInfo { hasNextPage endCursor } } } }' -f owner="$OWNER")
                else
                  response=$(gh api graphql -f query='query($owner: String!, $cursor: String!) { organization(login: $owner) { projectsV2(first: 100, after: $cursor) { nodes { number } pageInfo { hasNextPage endCursor } } } }' -f owner="$OWNER" -f cursor="$cursor")
                fi
                numbers=$(echo "$response" | jq -r '.data.organization.projectsV2.nodes[].number')
                has_next=$(echo "$response" | jq -r '.data.organization.projectsV2.pageInfo.hasNextPage')
                end_cursor=$(echo "$response" | jq -r '.data.organization.projectsV2.pageInfo.endCursor // empty')
              else
                if [ -z "$cursor" ]; then
                  response=$(gh api graphql -f query='query($owner: String!) { user(login: $owner) { projectsV2(first: 100) { nodes { number } pageInfo { hasNextPage endCursor } } } }' -f owner="$OWNER")
                else
                  response=$(gh api graphql -f query='query($owner: String!, $cursor: String!) { user(login: $owner) { projectsV2(first: 100, after: $cursor) { nodes { number } pageInfo { hasNextPage endCursor } } } }' -f owner="$OWNER" -f cursor="$cursor")
                fi
                numbers=$(echo "$response" | jq -r '.data.user.projectsV2.nodes[].number')
                has_next=$(echo "$response" | jq -r '.data.user.projectsV2.pageInfo.hasNextPage')
                end_cursor=$(echo "$response" | jq -r '.data.user.projectsV2.pageInfo.endCursor // empty')
              fi

              if [ -n "$numbers" ]; then
                if [ -z "$result" ]; then
                  result="$numbers"
                else
                  result="$result"$'\n'"$numbers"
                fi
              fi

              cursor="$end_cursor"
              [ -z "$cursor" ] && has_next="false"
            done

            echo "$result"
          }

          fetch_project_items() {
            local project_number="$1"
            local cursor=""
            local has_next="true"
            local end_cursor=""
            local response=""
            local page_items=""
            local result=""

            while [ "$has_next" = "true" ]; do
              if [ "$OWNER_TYPE" = "org" ]; then
                if [ -z "$cursor" ]; then
                  response=$(gh api graphql -f query='query($owner: String!, $number: Int!) { organization(login: $owner) { projectV2(number: $number) { items(first: 100) { nodes { id content { ... on DraftIssue { createdAt updatedAt } ... on Issue { createdAt updatedAt } ... on PullRequest { createdAt updatedAt } } } pageInfo { hasNextPage endCursor } } } } }' -F number="$project_number" -f owner="$OWNER")
                else
                  response=$(gh api graphql -f query='query($owner: String!, $number: Int!, $cursor: String!) { organization(login: $owner) { projectV2(number: $number) { items(first: 100, after: $cursor) { nodes { id content { ... on DraftIssue { createdAt updatedAt } ... on Issue { createdAt updatedAt } ... on PullRequest { createdAt updatedAt } } } pageInfo { hasNextPage endCursor } } } } }' -F number="$project_number" -f owner="$OWNER" -f cursor="$cursor")
                fi
                page_items=$(echo "$response" | jq -c '.data.organization.projectV2.items.nodes[] | {id: .id, created: .content.createdAt, updated: .content.updatedAt}')
                has_next=$(echo "$response" | jq -r '.data.organization.projectV2.items.pageInfo.hasNextPage')
                end_cursor=$(echo "$response" | jq -r '.data.organization.projectV2.items.pageInfo.endCursor // empty')
              else
                if [ -z "$cursor" ]; then
                  response=$(gh api graphql -f query='query($owner: String!, $number: Int!) { user(login: $owner) { projectV2(number: $number) { items(first: 100) { nodes { id content { ... on DraftIssue { createdAt updatedAt } ... on Issue { createdAt updatedAt } ... on PullRequest { createdAt updatedAt } } } pageInfo { hasNextPage endCursor } } } } }' -F number="$project_number" -f owner="$OWNER")
                else
                  response=$(gh api graphql -f query='query($owner: String!, $number: Int!, $cursor: String!) { user(login: $owner) { projectV2(number: $number) { items(first: 100, after: $cursor) { nodes { id content { ... on DraftIssue { createdAt updatedAt } ... on Issue { createdAt updatedAt } ... on PullRequest { createdAt updatedAt } } } pageInfo { hasNextPage endCursor } } } } }' -F number="$project_number" -f owner="$OWNER" -f cursor="$cursor")
                fi
                page_items=$(echo "$response" | jq -c '.data.user.projectV2.items.nodes[] | {id: .id, created: .content.createdAt, updated: .content.updatedAt}')
                has_next=$(echo "$response" | jq -r '.data.user.projectV2.items.pageInfo.hasNextPage')
                end_cursor=$(echo "$response" | jq -r '.data.user.projectV2.items.pageInfo.endCursor // empty')
              fi

              if [ -n "$page_items" ]; then
                if [ -z "$result" ]; then
                  result="$page_items"
                else
                  result="$result"$'\n'"$page_items"
                fi
              fi

              cursor="$end_cursor"
              [ -z "$cursor" ] && has_next="false"
            done

            echo "$result"
          }

          fetch_project_data() {
            local project_number="$1"

            if [ "$OWNER_TYPE" = "org" ]; then
              gh api graphql -f query='query($owner: String!, $number: Int!) { organization(login: $owner) { projectV2(number: $number) { id title fields(first: 100) { nodes { ... on ProjectV2Field { id name dataType } } } } } }' -F number="$project_number" -f owner="$OWNER" --jq '.data.organization.projectV2'
            else
              gh api graphql -f query='query($owner: String!, $number: Int!) { user(login: $owner) { projectV2(number: $number) { id title fields(first: 100) { nodes { ... on ProjectV2Field { id name dataType } } } } } }' -F number="$project_number" -f owner="$OWNER" --jq '.data.user.projectV2'
            fi
          }

          set_item_date() {
            local project_id="$1"
            local item_id="$2"
            local field_id="$3"
            local date_value="$4"

            gh api graphql -f query='
              mutation($project: ID!, $item: ID!, $field: ID!, $date: Date!) {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: $project
                    itemId: $item
                    fieldId: $field
                    value: { date: $date }
                  }
                ) {
                  projectV2Item { id }
                }
              }
            ' -f project="$project_id" -f item="$item_id" -f field="$field_id" -f date="$date_value" >/dev/null
          }

          # 1. Získání seznamu všech ID projektů (V2) pro daného vlastníka
          # Používá GraphQL kvůli kompatibilitě napříč verzemi gh
          PROJECT_LIST=$(fetch_project_numbers)

          if [ -z "$PROJECT_LIST" ]; then
            echo "Nebyly nalezeny žádné projekty."
            exit 0
          fi

          for PROJ_NR in $PROJECT_LIST; do
            echo "=========================================="
            echo "PROJEKT Č. $PROJ_NR"
            
            # Načtení dat o projektu (ID a existující pole)
            PROJ_DATA=$(fetch_project_data "$PROJ_NR")

            PROJ_ID=$(echo "$PROJ_DATA" | jq -r '.id')
            PROJ_TITLE=$(echo "$PROJ_DATA" | jq -r '.title')
            echo "Název: $PROJ_TITLE (ID: $PROJ_ID)"

            # Funkce pro zajištění existence pole (pokud neexistuje, vytvoří ho)
            ensure_field() {
              local field_name=$1
              local field_id=$(echo "$PROJ_DATA" | jq -r --arg name "$field_name" '.fields.nodes[]? | select((.name | type) == "string" and ((.name | ascii_downcase) == ($name | ascii_downcase))) | .id' | head -n1)
              
              if [ "$field_id" == "null" ] || [ -z "$field_id" ]; then
                echo "  -> Vytvářím pole '$field_name'..."
                gh api graphql -f query='
                  mutation($proj: ID!, $name: String!) {
                    createProjectV2Field(input: {projectId: $proj, name: $name, dataType: DATE}) {
                      projectV2Field { ... on ProjectV2Field { id } }
                    }
                  }' -f proj="$PROJ_ID" -f name="$field_name" >/dev/null 2>&1 || true

                PROJ_DATA=$(fetch_project_data "$PROJ_NR")
                field_id=$(echo "$PROJ_DATA" | jq -r --arg name "$field_name" '.fields.nodes[]? | select((.name | type) == "string" and ((.name | ascii_downcase) == ($name | ascii_downcase))) | .id' | head -n1)
              fi

              echo "$field_id"
            }

            FIELD_CREATED_ID=$(ensure_field "$FIELD_CREATED")
            FIELD_UPDATED_ID=$(ensure_field "$FIELD_UPDATED")

            # 2. Načtení položek projektu
            items=$(fetch_project_items "$PROJ_NR")

            # 3. Iterace přes položky a aktualizace dat
            echo "$items" | jq -c '.' | while read item; do
              ITEM_ID=$(echo "$item" | jq -r '.id')
              
              RAW_CREATED=$(echo "$item" | jq -r '.created // empty')
              RAW_UPDATED=$(echo "$item" | jq -r '.updated // empty')
              DATE_CREATED=""
              DATE_UPDATED=""
              
              [ ! -z "$RAW_CREATED" ] && DATE_CREATED=${RAW_CREATED:0:10}
              [ ! -z "$RAW_UPDATED" ] && DATE_UPDATED=${RAW_UPDATED:0:10}

              # Zápis dat (pokud jsou k dispozici)
              if [ ! -z "$DATE_CREATED" ] && [ ! -z "$FIELD_CREATED_ID" ] && [ "$FIELD_CREATED_ID" != "null" ]; then
                set_item_date "$PROJ_ID" "$ITEM_ID" "$FIELD_CREATED_ID" "$DATE_CREATED"
              fi
              if [ ! -z "$DATE_UPDATED" ] && [ ! -z "$FIELD_UPDATED_ID" ] && [ "$FIELD_UPDATED_ID" != "null" ]; then
                set_item_date "$PROJ_ID" "$ITEM_ID" "$FIELD_UPDATED_ID" "$DATE_UPDATED"
              fi
            done
            echo "Projekt $PROJ_NR hotov."
          done